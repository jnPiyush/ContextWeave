#!/bin/bash
# Context.md Post-Merge Hook
# Generates completion certificates and updates metrics after successful merge
# Triggered automatically after git merge completes

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
CERT_DIR="$REPO_ROOT/.agent-context/certificates"
METRICS_FILE="$REPO_ROOT/.agent-context/metrics.json"

# Create certificates directory if it doesn't exist
mkdir -p "$CERT_DIR"

# Extract issue number from merge commit message
MERGE_MSG=$(git log -1 --pretty=%B)
ISSUE_NUM=$(echo "$MERGE_MSG" | grep -oP '#\K\d+' | head -1)

if [ -z "$ISSUE_NUM" ]; then
    echo -e "${YELLOW}[INFO]${NC} No issue reference found in merge commit. Skipping certificate generation."
    exit 0
fi

echo -e "${BLUE}[INFO]${NC} Processing merge for issue #${ISSUE_NUM}..."

# Get commit details
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_SHORT=$(git rev-parse --short HEAD)
MERGE_DATE=$(git log -1 --format=%cd --date=iso)
AUTHOR=$(git log -1 --format='%an <%ae>')
BRANCH=$(git log -1 --format=%D | grep -oP 'origin/\K[^,]+' | head -1 || echo "unknown")

# Get changed files
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | wc -l)

# Get issue title from commit or local state
ISSUE_TITLE=$(echo "$MERGE_MSG" | head -1 | sed 's/#[0-9]*//g' | sed 's/^[a-z]*: //g' | xargs)

# Generate completion certificate
CERT_FILE="$CERT_DIR/CERT-${ISSUE_NUM}-${COMMIT_SHORT}.md"

cat > "$CERT_FILE" << EOFCERT
# Completion Certificate

**Issue**: #${ISSUE_NUM}
**Title**: ${ISSUE_TITLE}
**Status**: ✅ Completed
**Merged**: ${MERGE_DATE}

---

## Merge Details

- **Commit**: \`${COMMIT_HASH}\`
- **Branch**: \`${BRANCH}\`
- **Author**: ${AUTHOR}
- **Files Changed**: ${CHANGED_FILES}

---

## Verification

### Code Quality
- ✅ Code review completed
- ✅ All tests passing
- ✅ Branch merged to main

### Deliverables
- ✅ Implementation complete
- ✅ Documentation updated
- ✅ Tests included

---

**Certificate Generated**: $(date --iso-8601=seconds 2>/dev/null || date)
**Generated By**: Context.md Post-Merge Hook

---

*This certificate serves as proof of completion for issue #${ISSUE_NUM}*
EOFCERT

echo -e "${GREEN}[SUCCESS]${NC} Completion certificate generated: ${CERT_FILE}"
echo ""
echo -e "${GREEN}✓${NC} Post-merge processing complete for issue #${ISSUE_NUM}"
echo ""

exit 0
